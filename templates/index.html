{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('new_curation') }}" class="btn">+ New Curation</a>
</div>

<div class="card">
    <h2>Curations</h2>
    
    {% if curations %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Collection Name</th>
                <th>Size</th>
                <th>Keywords</th>
                <th>AI</th>
                <th>Min Rating</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for c in curations %}
            <tr>
                <td><strong>{{ c.name }}</strong></td>
                <td>{{ c.collection_name }}</td>
                <td><span class="badge badge-info">{{ c.max_items }}</span></td>
                <td>
                    {% if c.keywords %}
                        {{ c.keywords[:3]|join(', ') }}{% if c.keywords|length > 3 %}...{% endif %}
                    {% else %}
                        <span style="color: #999;">Auto-generate</span>
                    {% endif %}
                </td>
                <td>
                    {% if c.has_prompt %}
                        <span class="badge badge-success">Enabled</span>
                    {% else %}
                        <span class="badge badge-warning">Disabled</span>
                    {% endif %}
                </td>
                <td>{{ c.min_rating }}/10</td>
                <td>
                    <div class="actions">
                        <a href="{{ url_for('edit_curation', filename=c.filename) }}" class="btn btn-small btn-secondary">Edit</a>
                        <form method="POST" action="{{ url_for('run_curation_now', filename=c.filename) }}" style="display: inline;">
                            <button type="submit" class="btn btn-small" onclick="return confirm('Run this curation now?')">Run Now</button>
                        </form>
                        <form method="POST" action="{{ url_for('delete_curation', filename=c.filename) }}" style="display: inline;">
                            <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Delete this curation?')">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #999;">No curations yet. Create your first one!</p>
    {% endif %}
</div>

<div class="card">
    <h2>Scheduling</h2>
    <p class="help-text">Configure when curations run automatically</p>
    
    <!-- Monthly Auto-Curator -->
    <h3 style="color: #e5a00d; margin-top: 20px;">ðŸ“… Monthly Auto-Curator</h3>
    <p class="help-text">Automatically runs the correct month's YAML (january.yaml in January, etc.)</p>
    
    <table style="margin-bottom: 30px;">
        <thead>
            <tr>
                <th>Enabled</th>
                <th>Cron Schedule</th>
                <th>Description</th>
                <th>Detected Month Files</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <input type="checkbox" 
                           id="monthly-auto-enabled"
                           {% if schedule.monthly_auto.enabled %}checked{% endif %}>
                </td>
                <td>
                    <input type="text" 
                           id="monthly-auto-cron"
                           value="{{ schedule.monthly_auto.cron }}"
                           placeholder="0 0 1 * *"
                           style="width: 150px;">
                </td>
                <td>
                    <input type="text" 
                           id="monthly-auto-description"
                           value="{{ schedule.monthly_auto.description }}"
                           placeholder="Monthly auto-run">
                </td>
                <td>
                    <span class="badge badge-info">{{ monthly_curations|length }}/12 months</span>
                    {% if monthly_curations|length < 12 %}
                        <span style="color: #999; font-size: 0.85rem;">
                            (Missing: 
                            {% set found_months = monthly_curations|map(attribute='name')|list %}
                            {% for month in ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'] %}
                                {% if month not in found_months %}{{ month }}{% if not loop.last %}, {% endif %}{% endif %}
                            {% endfor %})
                        </span>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Individual Schedules -->
    <h3 style="color: #e5a00d; margin-top: 20px;">ðŸŽ¯ Individual Schedules</h3>
    <p class="help-text">Run specific curations on custom schedules (e.g., halloween.yaml on Oct 1st)</p>
    
    <table style="margin-bottom: 30px;">
        <thead>
            <tr>
                <th>Curation</th>
                <th>Cron Schedule</th>
                <th>Description</th>
                <th>Enabled</th>
            </tr>
        </thead>
        <tbody id="individual-schedule-table">
            {% for c in other_curations %}
            <tr>
                <td><strong>{{ c.name }}</strong></td>
                <td>
                    <input type="text" 
                           class="individual-cron" 
                           data-filename="{{ c.filename }}"
                           value="{{ schedule.individual.get(c.filename, {}).get('cron', '0 0 1 * *') }}"
                           placeholder="0 0 1 10 *"
                           style="width: 150px;">
                </td>
                <td>
                    <input type="text" 
                           class="individual-description"
                           data-filename="{{ c.filename }}"
                           value="{{ schedule.individual.get(c.filename, {}).get('description', '') }}"
                           placeholder="Run once per year">
                </td>
                <td>
                    <input type="checkbox" 
                           class="individual-enabled"
                           data-filename="{{ c.filename }}"
                           {% if c.filename in schedule.individual %}checked{% endif %}>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Recurring Curations -->
    <h3 style="color: #e5a00d; margin-top: 20px;">ðŸ”„ Recurring Curations</h3>
    <p class="help-text">Curations that run repeatedly (e.g., newest-movies.yaml every 2 weeks)</p>
    
    <table style="margin-bottom: 20px;">
        <thead>
            <tr>
                <th>Curation</th>
                <th>Cron Schedule</th>
                <th>Description</th>
                <th>Enabled</th>
            </tr>
        </thead>
        <tbody id="recurring-schedule-table">
            {% for c in other_curations %}
            <tr>
                <td><strong>{{ c.name }}</strong></td>
                <td>
                    <input type="text" 
                           class="recurring-cron" 
                           data-filename="{{ c.filename }}"
                           value="{{ schedule.recurring.get(c.filename, {}).get('cron', '0 0 */14 * *') }}"
                           placeholder="0 0 */14 * *"
                           style="width: 150px;">
                </td>
                <td>
                    <input type="text" 
                           class="recurring-description"
                           data-filename="{{ c.filename }}"
                           value="{{ schedule.recurring.get(c.filename, {}).get('description', '') }}"
                           placeholder="Every 2 weeks">
                </td>
                <td>
                    <input type="checkbox" 
                           class="recurring-enabled"
                           data-filename="{{ c.filename }}"
                           {% if c.filename in schedule.recurring %}checked{% endif %}>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background: #333; border-radius: 5px;">
        <strong style="color: #e5a00d;">Cron Examples:</strong><br>
        <span style="color: #999; font-size: 0.9rem;">
            â€¢ <code>0 0 1 * *</code> - Monthly (1st day)<br>
            â€¢ <code>0 0 */14 * *</code> - Every 14 days<br>
            â€¢ <code>0 0 * * 0</code> - Weekly (Sunday)<br>
            â€¢ <code>0 0 1 10 *</code> - October 1st only<br>
            â€¢ <code>0 2 * * *</code> - Daily at 2 AM
        </span>
    </div>
    
    <div style="margin-top: 20px;">
        <button onclick="saveSchedule()" class="btn">ðŸ’¾ Save All Schedules</button>
    </div>
</div>

<script>
function saveSchedule() {
    const schedules = {};
    document.querySelectorAll('.schedule-input').forEach(input => {
        const filename = input.dataset.filename;
        const cron = input.value;
        const description = document.querySelector(`.description-input[data-filename="${filename}"]`).value;
        const enabled = document.querySelector(`.schedule-enabled[data-filename="${filename}"]`).checked;
        
        schedules[filename] = {
            cron: cron,
            description: description,
            enabled: enabled
        };
    });
    
    fetch('/schedule/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(schedules)
    }).then(response => response.json())
      .then(data => {
          if (data.status === 'success') {
              alert('Schedule saved successfully!');
              location.reload();
          }
      });
}
</script>
{% endblock %}